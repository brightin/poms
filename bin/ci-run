#!/bin/bash --login
#
# Usage: bin/ci-run [--help|--job N]
#
# Run all tasks required for a Continuous Integration job. Also see ci-setup.
#
# Options:
#
#   --job N May be used for CI parallelisation. Use this number to do only part
#           of the usual work, for example by invoking different test scripts.
#   --help  Display this message.
#
# Examples:
#
#   Run all the tests for this project:
#
#     bin/ci-run
#
#   Run only part of the test suite:
#
#     bin/ci-run --job 1

set -e

# Run the actual tests for this project. The exit code of this function is
# determines the outcome of the CI build.
#
# TODO adapt the Rake command invokation below into something that makes sense for
#      your particular project.
run_tests() {
  # RVM is not activated in non-login shells, so we do so manually.
  RUBY_VERSION=$(cat .ruby-version)
  echo "Using Ruby $RUBY_VERSION"
  source $(rvm $RUBY_VERSION do rvm env --path)

  set -x
  bundle exec rubocop
  bundle exec reek
  bundle exec rspec
}

# Print help for this script by printing its top comment block (without the
# comment markers).
show_help() {
  awk '/^# Usage/,/^$/' $0 | cut -c 3-
  exit 1
}

if [[ $# -ge 1 ]]
then
  case $1 in
    "--job" ) run_tests $2;;
    * )       show_help;;
  esac
else
  run_tests
fi
